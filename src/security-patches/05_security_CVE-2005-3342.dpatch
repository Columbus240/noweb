#! /bin/sh /usr/share/dpatch/dpatch-run
## 05_security_CVE-2005-3342.dpatch by  <nr@eecs.harvard.edu>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: remove unacceptable uses of /tmp files 

@DPATCH@

diff -Nru noweb/contrib/rsc/rc/cpif.nw noweb/contrib/rsc/rc/cpif.nw
--- noweb/contrib/rsc/rc/cpif.nw	2000-03-28 01:52:18.000000000 +0200
+++ noweb/contrib/rsc/rc/cpif.nw	2005-10-26 00:50:47.000000000 +0200
@@ -24,7 +24,7 @@
 	exit usage
 }
 
-new=/tmp/noweb.$pid
+new=$(tempfile -p noweb) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
 
 # trap 'rm -f $new; exit 1' 1 2 15	# clean up files
 
diff -Nru noweb/contrib/rsc/rc/toascii.nw noweb/contrib/rsc/rc/toascii.nw
--- noweb/contrib/rsc/rc/toascii.nw	2000-03-28 01:52:18.000000000 +0200
+++ noweb/contrib/rsc/rc/toascii.nw	2005-10-26 00:51:38.000000000 +0200
@@ -38,9 +38,9 @@
 Also arranged here is a temporary file for storage of the awk program on an
 ugly system, as discussed below.
 <<arrange temporary files>>=
-awkfile=/tmp/awk$pid.tmp
-textfile=/tmp/text$pid.tmp
-tagsfile=/tmp/tags$pid.tmp
+awkfile=$(tempfile -p awk) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
+textfile=$(tempfile -p text ) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
+tagsfile=$(tempfile -p tags ) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
 @ %def textfile tagsfile awkfile
 The actual formatting of the text, code, and index entries is done by various
 unix text processing commands in pipelines.  There are four formatting pipes:
diff -Nru noweb/src/lib/h2a noweb/src/lib/h2a
--- noweb/src/lib/h2a	1999-09-16 22:07:47.000000000 +0200
+++ noweb/src/lib/h2a	2005-10-26 00:42:09.000000000 +0200
@@ -6,7 +6,7 @@
   -[0-9]*) opts="$opts -width=`expr 0 - $1`" ; shift ;;
 esac
 
-html=/tmp/$$.html; 
+html=`tempfile` ||  { echo "$0: Cannot create temporary file" >&2; exit 1;  }
 trap 'rm -f $html; exit 1' 1 2 15	# clean up files
 
 awk '
diff -Nru noweb/src/shell/roff.mm noweb/src/shell/roff.mm
--- noweb/src/shell/roff.mm	1998-08-18 21:33:04.000000000 +0200
+++ noweb/src/shell/roff.mm	2005-10-26 00:45:11.000000000 +0200
@@ -214,7 +214,7 @@
 .ADDLIST 1a
 .PRINTLIST
 
-awkfile="/tmp/noweb$$.awk"
+awkfile=$(tempfile -p noweb -s .awk) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
 trap 'rm -f $awkfile' 0 1 2 10 14 15
 cat > $awkfile \&<< 'EOF'
 \c
@@ -1628,14 +1628,15 @@
 tagsfile="$base.nwt"
 (echo ".so $macrodir/tmac.w"
 if [ -r "$tagsfile" ]; then 
-   cp $tagsfile /tmp/tags.$$
+   tagstemp=$(tempfile -p tags) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
+   cp $tagsfile $tagstemp
    $AWK '\c
 .USE "action for \*[BEGINCONVQUOTE]tags\*[ENDCONVQUOTE] line" 11c
 \&
          \c
 .USE "functions" 8a
-\&' /tmp/tags.$$
-   rm -f /tmp/tags.$$
+\&' $tagstemp
+   rm -f $tagstemp
  fi
  cat "$@") |
 ($ROFF $opts 2>$tagsfile)
diff -Nru noweb/src/shell/roff.nw noweb/src/shell/roff.nw
--- noweb/src/shell/roff.nw	1998-08-17 02:27:09.000000000 +0200
+++ noweb/src/shell/roff.nw	2005-10-26 00:46:47.000000000 +0200
@@ -80,7 +80,8 @@
 other, and quoting each quote is ugly.  The pragmatic solution is to
 copy the awk program into a temporary file, using a shell here-document.
 <<invoke awk program>>=
-awkfile="/tmp/noweb$$.awk"
+awkfile=$(tempfile -p noweb -s .awk) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
+
 trap 'rm -f $awkfile' 0 1 2 10 14 15
 cat > $awkfile << 'EOF'
 <<awk program>>
@@ -664,10 +665,11 @@
 tagsfile="$base.nwt"
 (echo ".so $macrodir/tmac.w"
 if [ -r "$tagsfile" ]; then 
-   cp $tagsfile /tmp/tags.$$
+   tagstemp=$(tempfile -p tags) || { echo "$0: Cannot create temporary file" >&2; exit 1;  }
+   cp $tagsfile $tagstemp
    $AWK '<<action for [[tags]] line>>
-         <<functions>>' /tmp/tags.$$
-   rm -f /tmp/tags.$$
+         <<functions>>' $tagstemp
+   rm -f $tagstemp
  fi
  cat "$@") |
 ($ROFF $opts 2>$tagsfile)
