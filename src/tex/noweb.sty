\input nwkernel

\codemargin=10pt
\advance\codehsize by \codemargin	% make room for indentation of code

\def\nowebshift{%
  \dimen0=-0.8in
  \if@twoside                 % Values for two-sided printing:
     \advance\evensidemargin by \dimen0
  \else                       % Values for one-sided printing:
     \advance\evensidemargin by \dimen0
     \advance\oddsidemargin by \dimen0
  \fi
}

\@ifundefined{chapter}{\let\nowebchunks@start=\section}%
                      {\let\nowebchunks@start=\chapter}
\def\nowebchunkssection{\nowebchunks@start*{List of chunk names}}

\let\nowebsize=\normalsize

\def\@begincode{\par\linewidth\codehsize\hsize\codehsize\textwidth\codehsize
  \parindent\z@\parfillskip\@flushglue\parskip\z@
  \item[]\if@minipage\else\vskip\parskip\fi
  \def\baselinestretch{1.0}\small\nowebsize
  \leftskip\@totalleftmargin\rightskip\z@
  \advance\leftskip\codemargin
  \@tempswafalse \def\par{\if@tempswa\hbox{}\fi\@tempswatrue\@@par}%
  \obeylines \tt \catcode``=13 \@noligs \setupcode}

\def\begincode#1{\begin{trivlist}\@begincode \frenchspacing\@vobeyspaces\parskip=\z@}
\def\endcode{\@endparenv\end{trivlist}}
\def\webcode{\begin{trivlist}\@begincode \frenchspacing\@vobeyspaces}
\def\endwebcode{\end{trivlist}}


\def\@begincode{\parindent\z@\parfillskip\@flushglue\parskip\z@
  \item[]\vskip\parskip
  \def\baselinestretch{1.0}\small\nowebsize
  \leftskip\@totalleftmargin\rightskip\z@
  \advance\leftskip\codemargin
  \@tempswafalse \def\par{\if@tempswa\hbox{}\fi\@tempswatrue\@@par}%
  \obeylines \tt \catcode``=13 \@noligs \setupcode}

% \noindent puts into horizontal mode so that lines can follow without
% indentation if there is no following \par.  The \hfil afterwards is
% some glue so that it there are lines following immediately, it will
% be possible to break there.  If I forced a break with \break, that
% would be wrong because a following \par would leave us with an
% underfull (empty!) hbox.

\def\begincode#1{\par\vskip3pt
    \penalty500
    \noindent\hbox to \hsize\bgroup\begin{minipage}{\codehsize}%
    \begin{trivlist}\@begincode \frenchspacing\@vobeyspaces\parskip=\z@}
\def\endcode{\end{trivlist}\vskip0.1pt\@endparenv\end{minipage}\hss\egroup\hfil}
\def\webcode{\par\vskip3pt\noindent\hbox to \hsize\bgroup\begin{minipage}{\codehsize}%
             \begin{trivlist}\@begincode \frenchspacing\@vobeyspaces}
\def\endwebcode{\strut\end{trivlist}\vskip0.1pt\end{minipage}\hss\egroup\hfil}



\def\code{\leavevmode\begingroup\setupcode\@vobeyspaces\obeylines}
\def\edoc{\endgroup}

\def\@maybreak#1{\vskip0pt plus #1\penalty-500\vskip0pt plus -#1}
\newcommand{\maybreak}{\@maybreak}
\def\begindocs#1{\relax\ifvmode\@maybreak{1in}\fi}
\def\nwdocspar{\par\@maybreak{1in}}
\def\enddocs{\relax}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% fix bug in {\LaTeX} headers 

% dreadful hack to fix bug in {\LaTeX} output routine (page number too
% far to right

% no patch for footers is possible

\let\@original@specialbopemit=\@specialbopemit
\def\@specialbopemit{\textwidth=\@original@textwidth\@original@specialbopemit}
\newdimen\@original@textwidth
\@original@textwidth=\textwidth

\def\ps@noweb{%
  \let\@mkboth\@gobbletwo
  \def\@oddfoot{}\def\@evenfoot{}%       No feet.
  \if@twoside         % If two-sided printing.
    \def\@evenhead{\hbox to \@original@textwidth{%
           \rm \thepage\qquad{\tt\leftmark}\hfil\today}}%        Left heading.
    \def\@oddhead{\hbox to \@original@textwidth{%
           \rm \today\hfil{\tt\leftmark}\qquad\thepage}}% Right heading.
  \else               % If one-sided printing.
    \def\@oddhead{\hbox to \@original@textwidth{%
           \rm \today\hfil{\tt\leftmark}\qquad\thepage}}% Right heading.
    \let\@evenhead\@oddhead
  \fi
  \def\chaptermark##1{}%
  \def\sectionmark##1{}%
  \def\subsectionmark##1{}%
  \def\subsubsectionmark##1{}%
  \def\paragraphmark##1{}%
  \def\subparagraphmark##1{}%
  \def\filename##1{\vfil\eject\markboth{##1}{##1}}%
}
\def\filename#1{\relax}

%%%%%%%%%%%%%%%% following code supports cross-referencing
% lists of page references cause all the trouble

\def\alsodefined#1{\break\hspace{-\codemargin}{\footnotesize\rm 
	This definition is continued on \pages{#1}.}\hfil}
\def\used#1{\break\hspace{-\codemargin}{\footnotesize\rm 
	This code is used on \pages{#1}.}\hfil}
\def\notused#1{\break\hspace{-\codemargin}{\footnotesize\rm 
	Root chunk (not used in this document).}\hfil}
\def\nwoutput#1{\break\hspace{-\codemargin}{\footnotesize\rm 
	This code is written to file {\tt #1}.}\hfil}


\def\empty{}
\def\lop#1\to#2{\expandafter\lopoff#1\lopoff#1#2}
\long\def\lopoff\\#1#2\lopoff#3#4{\def#4{#1}\def#3{#2}}
\def\loop#1\repeat{\def\iterate{#1\expandafter\iterate\fi}%
	\iterate \let\iterate\relax}

\def\thepageref#1{\@ifundefined{r@#1}{0\@warning
   {Reference `#1' on page \thepage \space 
    undefined}}{\@nameuse{r@#1}}}

\newcount\lastpage
\newcount\thispage
\newcount\pagesout

\def\dosetpage#1#2#3\@nil{\thispage=#2\relax}

\def\setthispage#1\done{%
   \@ifundefined{r@#1}{{\bf ??}\@warning
   {Reference `#1' on page \thepage \space 
    undefined}\thispage=0}{\edef\@tempa{\@nameuse{r@#1}}\expandafter
    \dosetpage\@tempa\@nil}}

\def\setpagenumbers#1{%
  \def\thepages{#1}%
  \def\pagenumbers{}%
  \lastpage=-1
  \loop\ifx\thepages\empty\else
     \lop\thepages\to\lastref
    \expandafter\setthispage\lastref\done
    \ifnum\thispage=\lastpage \else
      \edef\pagenumbers{\pagenumbers\noexpand\\{\the\thispage}}%
      \lastpage=\thispage  
    \fi
  \repeat}

\def\pages#1{%
  \setpagenumbers{#1}%
  \expandafter\dopages\pagenumbers\done
}

\def\dopages#1\done{%
  \def\thepages{#1}%
  \lop\thepages\to\lastref
  \lastpage=\lastref
  \ifx\thepages\empty page \else pages \fi
  \the\lastpage
  \pagesout=1
  \loop\ifx\thepages\empty\else
    \lop\thepages\to\lastref
    \thispage=\lastref
    \ifx\thepages\empty 
       \ifnum\pagesout>1 , \else{} \fi
       and 
    \else ,
    \fi 
    \the\thispage
    \advance\pagesout by 1
    \lastpage=\thispage  
  \repeat}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\subpageref}[1]{%
  \pageref{#1}%
  \@ifundefined{r@#1}%
    {}%
    {\@ifundefined{2on\@pageref{#1}}%
      {}%
      {\ref{#1}}}}
\def\@pageref#1{\expandafter\expandafter\expandafter
                \@cdr\csname r@#1\endcsname\@nil}
\newcommand{\sublabel}[1]{%
  \@bsphack\if@filesw {\let\thepage\relax
   \def\protect{\noexpand\noexpand\noexpand}%
   \edef\@tempa{\write\@auxout{\string
      \newsublabel{#1}{{}{\thepage}}}}%
   \expandafter}\@tempa
   \if@nobreak \ifvmode\nobreak\fi\fi\fi\@esphack}
\newcommand{\newsublabel}[2]{%
  \edef\this@page{\@cdr#2\@nil}%
  \ifnum\this@page>\last@page
    \sub@page=0\relax
  \fi
  \last@page=\this@page
  \advance\sub@page by 1
  \ifnum\sub@page=2
    \global\@namedef{2on\this@page}{}%
  \fi
  \edef\@tempa{\noexpand\newlabel{#1}%
    {{\@alph{\number\sub@page}}{\this@page}}}%
  \@tempa}
\newcount\last@page
\newcount\sub@page

